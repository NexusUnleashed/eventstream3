!function(){"use strict";function _typeof(obj){return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(obj){return typeof obj}:function(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj},_typeof(obj)}function _defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}function _possibleConstructorReturn(self,call){if(call&&("object"===_typeof(call)||"function"==typeof call))return call;if(void 0!==call)throw new TypeError("Derived constructors may only return object or undefined");return function _assertThisInitialized(self){if(void 0===self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return self}(self)}function _wrapNativeSuper(Class){var _cache="function"==typeof Map?new Map:void 0;return _wrapNativeSuper=function _wrapNativeSuper(Class){if(null===Class||!function _isNativeFunction(fn){return-1!==Function.toString.call(fn).indexOf("[native code]")}(Class))return Class;if("function"!=typeof Class)throw new TypeError("Super expression must either be null or a function");if(void 0!==_cache){if(_cache.has(Class))return _cache.get(Class);_cache.set(Class,Wrapper)}function Wrapper(){return _construct(Class,arguments,_getPrototypeOf(this).constructor)}return Wrapper.prototype=Object.create(Class.prototype,{constructor:{value:Wrapper,enumerable:!1,writable:!0,configurable:!0}}),_setPrototypeOf(Wrapper,Class)},_wrapNativeSuper(Class)}function _construct(Parent,args,Class){return _construct=_isNativeReflectConstruct()?Reflect.construct.bind():function _construct(Parent,args,Class){var a=[null];a.push.apply(a,args);var instance=new(Function.bind.apply(Parent,a));return Class&&_setPrototypeOf(instance,Class.prototype),instance},_construct.apply(null,arguments)}function _isNativeReflectConstruct(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}function _setPrototypeOf(o,p){return _setPrototypeOf=Object.setPrototypeOf?Object.setPrototypeOf.bind():function _setPrototypeOf(o,p){return o.__proto__=p,o},_setPrototypeOf(o,p)}function _getPrototypeOf(o){return _getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf.bind():function _getPrototypeOf(o){return o.__proto__||Object.getPrototypeOf(o)},_getPrototypeOf(o)}var EventStream=function(_EventTarget){!function _inherits(subClass,superClass){if("function"!=typeof superClass&&null!==superClass)throw new TypeError("Super expression must either be null or a function");subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,writable:!0,configurable:!0}}),Object.defineProperty(subClass,"prototype",{writable:!1}),superClass&&_setPrototypeOf(subClass,superClass)}(EventStream,_EventTarget);var _super=function _createSuper(Derived){var hasNativeReflectConstruct=_isNativeReflectConstruct();return function _createSuperInternal(){var result,Super=_getPrototypeOf(Derived);if(hasNativeReflectConstruct){var NewTarget=_getPrototypeOf(this).constructor;result=Reflect.construct(Super,arguments,NewTarget)}else result=Super.apply(this,arguments);return _possibleConstructorReturn(this,result)}}(EventStream);function EventStream(){var _this;return function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}(this,EventStream),(_this=_super.call(this)).stream={},_this.gmcpBackLog=[],_this.logging=!1,_this}return function _createClass(Constructor,protoProps,staticProps){return protoProps&&_defineProperties(Constructor.prototype,protoProps),staticProps&&_defineProperties(Constructor,staticProps),Object.defineProperty(Constructor,"prototype",{writable:!1}),Constructor}(EventStream,[{key:"registerEvent",value:function registerEvent(event,callback){var _this2=this,once=arguments.length>2&&void 0!==arguments[2]&&arguments[2],duration=arguments.length>3&&void 0!==arguments[3]&&arguments[3];this.stream[event]||(this.stream[event]=[]);var listener={controller:new AbortController,callback:callback,id:crypto.randomUUID()};duration&&(listener.timer=setTimeout((function(){_this2.removeListener(event,callback.name)}),duration),listener.controller.signal.onabort=function(){clearTimeout(listener.timer)});var callbackBundle=function callbackBundle(_ref){var detail=_ref.detail;try{listener.callback(detail)}catch(error){console.error("Evenstream raiseEvent error:\nevent: %s %o\ncallback %s: %o\ndata: %o\nerror: %o",event,_this2.stream[event],listener.callback.name,{callback:callback},detail,error)}finally{once&&_this2.removeListener(event,listener.callback.name)}};listener.callbackBundle=callbackBundle,callback.name&&this.removeListener(event,callback.name),this.addEventListener(event,callbackBundle,{once:once,signal:listener.controller.signal}),this.stream[event].push(listener)}},{key:"raiseEvent",value:function raiseEvent(event,data){this.dispatchEvent(new CustomEvent(event,{detail:data})),this.logging&&(console.log("eventStream event: ".concat(event)),console.log("eventStream data: ".concat(JSON.stringify(data))))}},{key:"removeListener",value:function removeListener(event,listener){var _this3=this,streamEvent=this.stream[event];if(streamEvent){var clearListener=function clearListener(index){_this3.removeEventListener(event,streamEvent[index].callbackBundle),streamEvent[index].controller.abort(),streamEvent.splice(index,1)};if("string"==typeof listener){var listenerIndex=streamEvent.findIndex((function(e){return e.callback.name===listener}));if(!(listenerIndex>=0))return!1;clearListener(listenerIndex)}else if(Number.isInteger(listener)&&listener<streamEvent.length)clearListener(listener);else{var index=streamEvent.findIndex((function(e){return e.callback===listener}));index>=0&&clearListener(index)}console.log("eventStream: Removed event ".concat(listener," on event ").concat(event,"."))}}},{key:"getListener",value:function getListener(event,id){var _this$stream$event;return null===(_this$stream$event=this.stream[event])||void 0===_this$stream$event?void 0:_this$stream$event.find((function(e){return e.callback.name===id}))}},{key:"purge",value:function purge(event){if(event)if("ALL"===event){for(var ev in this.stream)this.stream[ev].forEach((function(cb){return cb.controller.abort()}));this.stream={}}else this.stream[event]&&(this.stream[event].forEach((function(callback){return callback.controller.abort()})),this.stream[event]=[]);else console.log("eventStream: attempted to purge invalid event")}},{key:"gmcpHandler",value:function gmcpHandler(){for(;this.gmcpBackLog.length>0;){var currentArgs=this.gmcpBackLog.shift();currentArgs.gmcp_method&&(setAtString(globalThis.GMCP,currentArgs.gmcp_method.split("."),currentArgs.gmcp_args),this.raiseEvent(currentArgs.gmcp_method,currentArgs.gmcp_args))}}},{key:"gmcpHandlerRaw",value:function gmcpHandlerRaw(gmcp){gmcp.gmcp_method&&(setAtString(globalThis.GMCP,gmcp.gmcp_method.split("."),gmcp.gmcp_args),this.raiseEvent(gmcp.gmcp_method,gmcp.gmcp_args))}}]),EventStream}(_wrapNativeSuper(EventTarget)),setAtString=function setAtString(obj,dotarr,val){for(var current=obj,i=0;i<dotarr.length-1;i++){var key=dotarr[i];current[key]=current[key]||{},current=current[key]}var lastKey=dotarr[dotarr.length-1];"object"!==_typeof(val)||Array.isArray(val)?current[lastKey]=val:current[lastKey]=Object.assign(current[lastKey]||{},val)};function Timer_classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function Timer_defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}var Timer=function(){function Timer(id){var length=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;Timer_classCallCheck(this,Timer),this._id=id,this._enabled=!1,this._startTime=0,this._endTime=0,this._timerId=0,this._defaultLength=length,this.setLength(length),this._callbacks=[]}return function Timer_createClass(Constructor,protoProps,staticProps){return protoProps&&Timer_defineProperties(Constructor.prototype,protoProps),staticProps&&Timer_defineProperties(Constructor,staticProps),Object.defineProperty(Constructor,"prototype",{writable:!1}),Constructor}(Timer,[{key:"length",get:function get(){return this._length}},{key:"id",get:function get(){return this._id}},{key:"enabled",get:function get(){return this._enabled}},{key:"setLength",value:function setLength(length){if(length<0)throw new Error("Timer length cannot be negative");this._length=length}},{key:"reset",value:function reset(){clearTimeout(this._timerId),this._enabled=!1,this.setLength(this._defaultLength),this._endTime=performance.now()/1e3,eventStream.raiseEvent("timerReset".concat(this._id))}},{key:"start",value:function start(){clearTimeout(this._timerId),this._startTimer(),eventStream.raiseEvent("timerStarted".concat(this._id))}},{key:"_startTimer",value:function _startTimer(){this._timerId=setTimeout(this.stop.bind(this),1e3*this._length),this._enabled=!0,this._startTime=performance.now()/1e3}},{key:"stop",value:function stop(){this._enabled&&(clearTimeout(this._timerId),this._endTime=performance.now()/1e3,this._enabled=!1,eventStream.raiseEvent("timerStopped".concat(this._id)))}},{key:"duration",value:function duration(){return this._enabled?this.elapsed():this._endTime-this._startTime}},{key:"elapsed",value:function elapsed(){return this._enabled?performance.now()/1e3-this._startTime:0}},{key:"remaining",value:function remaining(){return this._enabled?this._length-this.elapsed():this._length}}],[{key:"createTimer",value:function createTimer(name){var length=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return new Timer(name,length)}}]),Timer}(),base_Timer=Timer.createTimer;globalThis.EventStream=EventStream,globalThis.eventStream=new EventStream,globalThis.eventStream.createTimer=base_Timer;"undefined"!=typeof nexusclient&&"khaseem"!==nexusclient.charname.toLowerCase()&&(function updateNxs(){fetch("https://unpkg.com/nexevent/eventStream3.nxs",{cache:"no-store"}).then((function(response){return response.json()})).then((function(data){nexusclient.packages().get("eventStream3").apply(data,nexusclient.reflexes())}))}(),function applyOverride(){globalThis.nexusclient.process_lines=function(lines){if(!this.gagged&&lines.length){this.current_block=lines;for(var reflexes=this.reflexes(),idx=0;idx<lines.length&&!(idx>=1e3);++idx)this.current_line=lines[idx],this.current_line.index=idx,lines[idx].line&&lines[idx].line.indexOf(String.fromCharCode(7))>=0&&this.platform().beep(),this.fullstop||(lines=reflexes.handle_triggers(lines,idx));reflexes.run_function("onBlock",lines,"ALL"),this.ui().buffer().add_block(lines),this.current_line=void 0,this.current_block=void 0}},console.log("[eventStream]: Overrides applied")}())}();